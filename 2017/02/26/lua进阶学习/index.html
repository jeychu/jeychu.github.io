

<!DOCTYPE html>
<html lang xmlns:v-bind="http://www.w3.org/1999/xhtml">

<head><meta name="generator" content="Hexo 3.8.0">
    <title>lua进阶学习 - javfa&#39;s blog</title>
<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="author" content="Javfa">
<meta name="description" content="

Lua简介
Lua是什么？
Lua和LuaJIT的区别


入门
基础数据结构
nil
boolean
num...">
<meta name="keywords" content>

    <meta charset="utf-8">
    <meta name="X-UA-Compatible" content="IE=edge">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <meta content="telephone=no" name="format-detection">
    <meta name="renderer" content="webkit">
    <meta name="theme-color" content="#ffffff">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha256-eSi1q2PG6J7g7ib17yAaWMcrr5GrtohYChqibrV7PBE=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/journal.css?3512428">
<script src="/js/loadCSS.js"></script>
<script>
    loadCSS("https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Material+Icons");
    (function (d) {
        var config = {
                kitId: 'dwg1tuc',
                scriptTimeout: 3000,
                async: true
            },
            h = d.documentElement, t = setTimeout(function () {
                h.className = h.className.replace(/\bwf-loading\b/g, "") + " wf-inactive";
            }, config.scriptTimeout), tk = d.createElement("script"), f = false,
            s = d.getElementsByTagName("script")[0], a;
        h.className += " wf-loading";
        tk.src = 'https://use.typekit.net/' + config.kitId + '.js';
        tk.async = true;
        tk.onload = tk.onreadystatechange = function () {
            a = this.readyState;
            if (f || a && a != "complete" && a != "loaded") return;
            f = true;
            clearTimeout(t);
            try {
                Typekit.load(config)
            } catch (e) {
            }
        };
        s.parentNode.insertBefore(tk, s)
    })(document);
</script>
<noscript>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora|Montserrat|Anonymous+Pro:400|Material+Icons">
</noscript>
</head>
<body>
<div id="top"></div>
<div id="app">
<div class="single-column-drawer-container" ref="drawer" v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            <a class="a-block drawer-menu-item false" href="http://yoursite.com">
                ホーム
            </a>
            <a class="a-block drawer-menu-item false" href="/archives">
                記事一覧
            </a>

            
            

            
        </div>
    </div>
</div>
<transition name="fade">
    <div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div ref="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a ref="navTitle" class="navbar-brand" href="/">
            javfa&#39;s blog
        </a>
    </div>
</nav>
<div class="single-column-header-container" ref="pageHead" v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="/">
        <div class="single-column-header-title">javfa&#39;s blog</div>
        <div class="single-column-header-subtitle"></div>
    </a>
</div>
<div ref="sideContainer" class="side-container">
    <a class="a-block nav-head false" href="/">
        <div class="nav-title">
            {博客@家發}
        </div>
        <div class="nav-subtitle">
            隻言片語<br>於此匯聚
        </div>
    </a>

    <div class="nav-link-list">
        <a class="a-block no-tint nav-link-item false" href="/archives">
            記事一覧
        </a>

        
        

        
    </div>

    
    <div class="nav-footer">
        Proudly published with Hexo<br>
        
        Theme <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> by <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a><br>
        
        &copy; 2019 <a href="http://yoursite.com">javfa&#39;s blog</a>
    </div>
</div>
<div ref="extraContainer" class="extra-container">
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>

        
    </div>
</div>

<div ref="streamContainer" class="stream-container">
    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            <div class="post-head-wrapper-text-only" style="background-image: url('')">
                <div class="post-title">
                    lua进阶学习
                    <div class="post-meta">
                        <time datetime="2017-02-25T16:54:43.000Z" itemprop="datePublished">
                            2017-02-26 00:54
                        </time>&nbsp;
                        
    
                        
                        
                        <i class="material-icons" style>label</i>
                        
                        <a href="/tags/lua/">lua</a>
                        
                        
                    </div>
                </div>
            </div>
    
            <div class="post-body-wrapper">
                <div class="post-body">
                    <!-- toc -->
<ul>
<li><a href="#lua简介">Lua简介</a><ul>
<li><a href="#lua是什么">Lua是什么？</a></li>
<li><a href="#lua和luajit的区别">Lua和LuaJIT的区别</a></li>
</ul>
</li>
<li><a href="#入门">入门</a><ul>
<li><a href="#基础数据结构">基础数据结构</a><ul>
<li><a href="#nil">nil</a></li>
<li><a href="#boolean">boolean</a></li>
<li><a href="#number">number</a></li>
<li><a href="#string">string</a></li>
<li><a href="#table">table</a></li>
<li><a href="#function">function</a></li>
</ul>
</li>
<li><a href="#表达式">表达式</a><ul>
<li><a href="#算术运算符">算术运算符</a></li>
<li><a href="#关系运算符">关系运算符</a></li>
<li><a href="#逻辑运算符">逻辑运算符</a></li>
<li><a href="#字符串连接">字符串连接</a></li>
<li><a href="#优先级">优先级</a></li>
</ul>
</li>
<li><a href="#控制结构">控制结构</a><ul>
<li><a href="#if-else">if-else</a><ul>
<li><a href="#单个if分支型">单个if分支型</a></li>
<li><a href="#两个分支-if-else-型">两个分支 if-else 型</a></li>
<li><a href="#多个分支-if-elseif-else-型">多个分支 if-elseif-else 型</a><ul>
<li><a href="#while">while</a></li>
<li><a href="#repeat">repeat</a></li>
<li><a href="#for">for</a></li>
</ul>
</li>
<li><a href="#for数字型">for数字型</a></li>
<li><a href="#for泛型">for泛型</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#函数">函数</a><ul>
<li><a href="#定义">定义</a></li>
<li><a href="#参数">参数</a></li>
<li><a href="#返回值">返回值</a></li>
</ul>
</li>
<li><a href="#模块">模块</a></li>
<li><a href="#string库">String库</a></li>
<li><a href="#table库">Table库</a></li>
<li><a href="#日期时间函数">日期时间函数</a></li>
<li><a href="#数学库函数">数学库函数</a></li>
<li><a href="#文件操作">文件操作</a></li>
</ul>
</li>
<li><a href="#高阶">高阶</a><ul>
<li><a href="#元表">元表</a></li>
<li><a href="#面向对象编程">面向对象编程</a></li>
<li><a href="#局部变量">局部变量</a></li>
<li><a href="#判断数组大小">判断数组大小</a></li>
<li><a href="#非空判断">非空判断</a></li>
<li><a href="#正则表达式">正则表达式</a></li>
<li><a href="#虚变量">虚变量</a></li>
<li><a href="#ffi">FFI</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->
<h1><span id="lua简介">Lua简介</span></h1><h2><span id="lua是什么">Lua是什么？</span></h2><p>1993年Lua诞生于巴西里约热内卢天主教大学。浪漫的名字Lua所代表的意思是美丽的月亮。</p>
<p>正如它的名字，Lua极为简洁、优雅且富有乐趣。</p>
<p>从一开始，Lua就是作为一门方便嵌入到其他应用程序，并可扩展的轻量级脚本语言来设计的，因此她一直遵循着简单、小巧、可移植、快速的原则，官方实现完全采用ANSI C编写，能以C程序库的形式嵌入到宿主程序中。</p>
<p>在游戏开发、机器人控制、分布式应用、图像处理、生物信息学等领域得到了广泛应用。其中，尤以游戏开发为最，用Lua可以快捷高效地配合游戏引擎完成数据描述、配置管理和逻辑控制等任务。</p>
<p>Lua是一门过程型动态语言，有如下特性：</p>
<ul>
<li>变量名没有类型，值才有类型，变量名在运行时可与任何类型的值绑定；</li>
<li>只提供唯一一种数据结构，称为表（table），它混合了数组、哈希，可以用任何类型的值作为key和value。一致且富有表达力的表构造语法，使得Lua很适合描述复杂的数据；</li>
<li>支持匿名函数和正则尾递归；</li>
<li>支持词法定界和闭包；</li>
<li>提供thread和coroutine机制，实现协作式多任务；</li>
<li>运行期能编译字符串形式的程序文本并载入虚拟机执行；</li>
<li>通过metatable和metamethod提供dynamic metamechanism，从而允许程序运行时根据需要改变或扩充语法设施的内定语义；</li>
<li>能方便的利用表和dynamic metamechanism实现prototype-based的面向对象模型；</li>
<li>提供完善的模块机制，从而更好地支持开发大型的应用程序；</li>
</ul>
<h2><span id="lua和luajit的区别">Lua和LuaJIT的区别</span></h2><p>Lua非常高效，通过第三方的独立评测也证实，它运行得比Perl、Python、Ruby等其他脚本都快。但是，还不够快。LuaJIT（Lua Just-in Time）则尝试利用即时编译技术把Lua代码编译成本地机器码后交给CPU直接执行，又显著的加速了Lua。</p>
<p>LuaJIT是一个更为高效的Lua实现。支持更多的基本原语和特性，因此功能上也要更为强大。</p>
<p>以下内容都是基于<a href="http://luajit.org" target="_blank" rel="noopener">LuaJIT</a>进行介绍的。</p>
<h1><span id="入门">入门</span></h1><h2><span id="基础数据结构">基础数据结构</span></h2><h3><span id="nil">nil</span></h3><p>nil是一种类型，表示“无效值”。一个变量在第一次赋值前的默认值是nil，将nil赋值给一个全局变量就等同于删除它。</p>
<p>如果一个变量被设置为nil，就等于说该变量未定义，与无穷无尽的其他为定义的变量是一样的。也就是表示该变量不存在。</p>
<p>OpenResty的lua接口还提供了一种特殊的空值，即ngx.null，用来表示不同于nil的空值。</p>
<p><a href="https://pureage.info/2013/09/02/125.html" target="_blank" rel="noopener">二者的区别</a>是：</p>
<p>nil是Lua的一种类型，该类型只有nil一个值，作用只有一个，表示一个变量不存在，未定义。</p>
<p>ngx.null则是一个userdata类型的值，表示查询为空。</p>
<h3><span id="boolean">boolean</span></h3><p>Lua中nil和false为“假”，其他所有值均为“真”。</p>
<p>比如0和空字符串都是“真”。</p>
<h3><span id="number">number</span></h3><p>表示实数，和C/C++里面的double类型类似。</p>
<p>可用math.floor(向下取整)和math.ceil(向上取整)进行取整操作。</p>
<h3><span id="string">string</span></h3><p>有三种方式表示字符串：</p>
<ul>
<li><p>单引号</p>
</li>
<li><p>双引号</p>
</li>
<li><p>长括号（即[[]]）:</p>
<p>在两个正的方括号之间插入n个等号定义为第n级正长括号。也就是说，[[是0级正长括号，[=[是1级，以此类推。反的长括号也作此类似定义。</p>
<p>则在n级正反长括号之间的字符串，不受分行限制，不处理任何转义符，忽略掉任何不同级别的长括号，即可以包含除本级别反长括号之外的任何东西。</p>
<p>例如：[=[abc\nbca]=]，里面的“\n”不会被转义。</p>
</li>
</ul>
<p>Lua的字符串是不可改变的值，不能像在C语言中那样直接修改字符串的某个字符，而是根据修改要求来创建一个新的字符串。</p>
<p>Lua也不能通过下标来访问字符串的某个字符。</p>
<p>Lua字符串一般都会经历一个内化的过程，即两个完全一样的Lua字符串在Lua虚拟机中只会存储一份。每一个Lua字符串在创建时都会插入到Lua虚拟机内部的一个全局的哈希表中。这意味着：</p>
<ul>
<li>创建相同的Lua字符串并不会引入新的动态内存分配操作，所以相对节省开销（但仍有全局哈希表查询的开销）</li>
<li>内容相同的Lua字符串不会占用多份存储空间</li>
<li>已经创建好的Lua字符串之间进行相等性比较时是<code>O(1)</code>时间度的开销，而不是通常所见的<code>O(n)</code></li>
</ul>
<h3><span id="table">table</span></h3><p>一种抽象的关联数组。是一种具有特殊索引方式的数组，索引通常是字符串或number类型，也可以是除nil以外的任意类型的值。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> corp = &#123;</span><br><span class="line">    web = <span class="string">"www.google.com"</span>,   <span class="comment">--索引为字符串，key = "web",</span></span><br><span class="line">                              <span class="comment">--            value = "www.google.com"</span></span><br><span class="line">    telephone = <span class="string">"12345678"</span>,   <span class="comment">--索引为字符串</span></span><br><span class="line">    staff = &#123;<span class="string">"Jack"</span>, <span class="string">"Scott"</span>, <span class="string">"Gary"</span>&#125;, <span class="comment">--索引为字符串，值也是一个表</span></span><br><span class="line">    <span class="number">100876</span>,              <span class="comment">--相当于 [1] = 100876，此时索引为数字</span></span><br><span class="line">                         <span class="comment">--      key = 1, value = 100876</span></span><br><span class="line">    <span class="number">100191</span>,              <span class="comment">--相当于 [2] = 100191，此时索引为数字</span></span><br><span class="line">    [<span class="number">10</span>] = <span class="number">360</span>,          <span class="comment">--直接把数字索引给出</span></span><br><span class="line">    [<span class="string">"city"</span>] = <span class="string">"Beijing"</span> <span class="comment">--索引为字符串</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(corp.web)               <span class="comment">--&gt;output:www.google.com</span></span><br><span class="line"><span class="built_in">print</span>(corp[<span class="string">"telephone"</span>])      <span class="comment">--&gt;output:12345678</span></span><br><span class="line"><span class="built_in">print</span>(corp[<span class="number">2</span>])                <span class="comment">--&gt;output:100191</span></span><br><span class="line"><span class="built_in">print</span>(corp[<span class="string">"city"</span>])           <span class="comment">--&gt;output:"Beijing"</span></span><br><span class="line"><span class="built_in">print</span>(corp.staff[<span class="number">1</span>])          <span class="comment">--&gt;output:Jack</span></span><br><span class="line"><span class="built_in">print</span>(corp[<span class="number">10</span>])               <span class="comment">--&gt;output:360</span></span><br></pre></td></tr></table></figure>
<p>在内部实现上，table通常实现为一个哈希表、一个数组或者两者的混合。</p>
<h3><span id="function">function</span></h3><p>Lua的函数也是一种数据类型，函数可以存储在变量中，可以通过参数传递给其他函数，还可以作为其他函数的返回值。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"in the function"</span>)</span><br><span class="line">    <span class="comment">--dosomething()</span></span><br><span class="line">    <span class="keyword">local</span> x = <span class="number">10</span></span><br><span class="line">    <span class="keyword">local</span> y = <span class="number">20</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> a = foo    <span class="comment">--把函数赋给变量</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(a())</span><br><span class="line"></span><br><span class="line"><span class="comment">--output:</span></span><br><span class="line"><span class="keyword">in</span> the <span class="function"><span class="keyword">function</span></span></span><br><span class="line"><span class="function">30</span></span><br></pre></td></tr></table></figure>
<p>有名函数的定义实质上是匿名函数对变量的赋值。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>等价于</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">foo = <span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2><span id="表达式">表达式</span></h2><h3><span id="算术运算符">算术运算符</span></h3><table>
<thead>
<tr>
<th>算术运算符</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>+</td>
<td>加法</td>
</tr>
<tr>
<td>-</td>
<td>减法</td>
</tr>
<tr>
<td>*</td>
<td>乘法</td>
</tr>
<tr>
<td>/</td>
<td>除法</td>
</tr>
<tr>
<td>^</td>
<td>指数</td>
</tr>
<tr>
<td>%</td>
<td>取模</td>
</tr>
</tbody>
</table>
<h3><span id="关系运算符">关系运算符</span></h3><table>
<thead>
<tr>
<th>关系运算符</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>&lt;</td>
<td>小于</td>
</tr>
<tr>
<td>&gt;</td>
<td>大于</td>
</tr>
<tr>
<td>&lt;=</td>
<td>小于等于</td>
</tr>
<tr>
<td>&gt;=</td>
<td>大于等于</td>
</tr>
<tr>
<td>==</td>
<td>等于</td>
</tr>
<tr>
<td>~=</td>
<td>不等于</td>
</tr>
</tbody>
</table>
<p>在使用“==”做等于判断时，要注意对于 table, userdate 和函数， Lua 是作引用比较的。也就是说，只有当两个变量引用同一个对象时，才认为它们相等。</p>
<h3><span id="逻辑运算符">逻辑运算符</span></h3><table>
<thead>
<tr>
<th>逻辑运算符</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>and</td>
<td>逻辑与</td>
</tr>
<tr>
<td>or</td>
<td>逻辑或</td>
</tr>
<tr>
<td>not</td>
<td>逻辑非</td>
</tr>
</tbody>
</table>
<ul>
<li><code>a and b</code> 如果 a 为 nil，则返回 a，否则返回 b;</li>
<li><code>a or b</code> 如果 a 为 nil，则返回 b，否则返回 a。</li>
</ul>
<h3><span id="字符串连接">字符串连接</span></h3><p>使用“..”来连接两个字符串。数字会转换为字符串，然后做连接。</p>
<p>连接只会创建一个新字符串，而不会改变原操作数。</p>
<p>也可以使用string.format连接字符串。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">"Hello "</span> .. <span class="string">"World"</span>)    <span class="comment">--&gt;打印 Hello World</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">0</span> .. <span class="number">1</span>)                 <span class="comment">--&gt;打印 01</span></span><br><span class="line"></span><br><span class="line">str1 = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"%s-%s"</span>,<span class="string">"hello"</span>,<span class="string">"world"</span>)</span><br><span class="line"><span class="built_in">print</span>(str1)              <span class="comment">--&gt;打印 hello-world</span></span><br><span class="line"></span><br><span class="line">str2 = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"%d-%s-%.2f"</span>,<span class="number">123</span>,<span class="string">"world"</span>,<span class="number">1.21</span>)</span><br><span class="line"><span class="built_in">print</span>(str2)              <span class="comment">--&gt;打印 123-world-1.21</span></span><br></pre></td></tr></table></figure>
<p>table和table.concat()可进行很多字符串的拼接，又能避免用“..”做连接时不断的创建新的字符串而导致的巨大性能开销。</p>
<h3><span id="优先级">优先级</span></h3><table>
<thead>
<tr>
<th style="text-align:center">优先级(从高到低)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">^</td>
</tr>
<tr>
<td style="text-align:center">not   # -</td>
</tr>
<tr>
<td style="text-align:center">*   /   %</td>
</tr>
<tr>
<td style="text-align:center">+   -</td>
</tr>
<tr>
<td style="text-align:center">..</td>
</tr>
<tr>
<td style="text-align:center">&lt; &gt; &lt;=  &gt;=  ==  ~=</td>
</tr>
<tr>
<td style="text-align:center">and</td>
</tr>
<tr>
<td style="text-align:center">or</td>
</tr>
</tbody>
</table>
<h2><span id="控制结构">控制结构</span></h2><h3><span id="if-else">if-else</span></h3><h5><span id="单个if分支型">单个if分支型</span></h5><h5><span id="两个分支-if-else-型">两个分支 if-else 型</span></h5><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="number">10</span></span><br><span class="line"><span class="keyword">if</span> x &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"x is a positive number"</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"x is a non-positive number"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h5><span id="多个分支-if-elseif-else-型">多个分支 if-elseif-else 型</span></h5><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">score = <span class="number">90</span></span><br><span class="line"><span class="keyword">if</span> score == <span class="number">100</span> <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Very good!Your score is 100"</span>)</span><br><span class="line"><span class="keyword">elseif</span> score &gt;= <span class="number">60</span> <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Congratulations, you have passed it,your score greater or equal to 60"</span>)</span><br><span class="line"><span class="comment">--此处可以添加多个elseif</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Sorry, you do not pass the exam! "</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h4><span id="while">while</span></h4><p>while 型控制结构语法如下，当表达式值为假（即 false 或 nil）时结束循环。也可以使用 break 语言提前跳出循环。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> 表达式 <span class="keyword">do</span></span><br><span class="line"><span class="comment">--body</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>break可以跳出当前循环。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> t = &#123;<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">11</span>, <span class="number">18</span>, <span class="number">21</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> i</span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(t) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> <span class="number">11</span> == v <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"index["</span> .. i .. <span class="string">"] have right value[11]"</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h4><span id="repeat">repeat</span></h4><p>类似于do-while，但控制方式刚好相反：</p>
<p>执行repeat循环体时，直到until条件为真时才结束。</p>
<p>以下代码将会形成死循环：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="number">10</span></span><br><span class="line"><span class="keyword">repeat</span></span><br><span class="line">    <span class="built_in">print</span>(x)</span><br><span class="line"><span class="keyword">until</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<h4><span id="for">for</span></h4><h5><span id="for数字型">for数字型</span></h5><p>语法如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> var = begin, finish, step <span class="keyword">do</span></span><br><span class="line">    <span class="comment">--body</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>step是可选的，默认为1。</p>
<p>如果不想给循环设置上限的话，可以使用常量math.huge：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, <span class="built_in">math</span>.<span class="built_in">huge</span> <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0.3</span>*i^<span class="number">3</span> - <span class="number">20</span>*i^<span class="number">2</span> - <span class="number">500</span> &gt;=<span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">print</span>(i)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h5><span id="for泛型">for泛型</span></h5><p>泛型for循环通过一个迭代器函数来遍历所有值：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 打印数组a的所有值</span></span><br><span class="line"><span class="keyword">local</span> a = &#123;<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>&#125;</span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"index:"</span>, i, <span class="string">" value:"</span>, v)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- output:</span></span><br><span class="line">index:  <span class="number">1</span>  value: a</span><br><span class="line">index:  <span class="number">2</span>  value: b</span><br><span class="line">index:  <span class="number">3</span>  value: c</span><br><span class="line">index:  <span class="number">4</span>  value: d</span><br></pre></td></tr></table></figure>
<p>ipairs是一个用于遍历数组的迭代器函数。在每次循环中，i是索引值，v是对应于该索引的数组元素值。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 打印table t中所有的key</span></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">pairs</span>(t) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(k)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>泛型for非常强大。通过不同的迭代器，几乎可以遍历所有东西。</p>
<p>标准库通过了几种迭代器，包括用于迭代文件中的每行的io.lines、迭代table元素的pairs、迭代数组元素的ipairs、迭代字符串中单词的string.gmatch等。</p>
<h2><span id="函数">函数</span></h2><h3><span id="定义">定义</span></h3><p>使用关键字function定义函数：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">function_name</span> <span class="params">(arc)</span></span>  <span class="comment">-- arc 表示参数列表，函数的参数列表可以为空</span></span><br><span class="line">   <span class="comment">-- body</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>上面的语法定义了一个全局函数。</p>
<p>由于全局函数一般会污染全局名字空间，特殊也有性能损耗（即查询全局环境表的开销），因此我们应当尽量使用“局部函数”，记法类似，只是开通加上local修饰符：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">function_name</span> <span class="params">(arc)</span></span></span><br><span class="line">  <span class="comment">-- body</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>由于函数定义本质上是变量赋值，而变量的定义总是应放在变量使用之前，所有函数的定义也需要放置在函数调用之前。</p>
<p>由于函数定义等价于变量赋值，我们可以把函数名替换为某个Lua表的某个字段：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo.bar</span><span class="params">(a, b, c)</span></span></span><br><span class="line">    <span class="comment">-- body ...</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>等价于：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">foo.bar = <span class="function"><span class="keyword">function</span> <span class="params">(a, b, c)</span></span></span><br><span class="line">    <span class="built_in">print</span>(a, b, c)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3><span id="参数">参数</span></h3><ul>
<li><p>按值传递</p>
<p>实参通过它在参数表中的位置与形参匹配起来，把自己的值赋值传递给形参，之后二者就没有关系了。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">swap</span><span class="params">(a, b)</span></span> <span class="comment">--定义函数swap,函数内部进行交换两个变量的值</span></span><br><span class="line">   <span class="keyword">local</span> temp = a</span><br><span class="line">   a = b</span><br><span class="line">   b = temp</span><br><span class="line">   <span class="built_in">print</span>(a, b)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> x = <span class="string">"hello"</span></span><br><span class="line"><span class="keyword">local</span> y = <span class="number">20</span></span><br><span class="line"><span class="built_in">print</span>(x, y)</span><br><span class="line">swap(x, y)    <span class="comment">--调用swap函数</span></span><br><span class="line"><span class="built_in">print</span>(x, y)   <span class="comment">--调用swap函数后，x和y的值并没有交换</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--&gt;output</span></span><br><span class="line">hello <span class="number">20</span></span><br><span class="line"><span class="number">20</span>  hello</span><br><span class="line">hello <span class="number">20</span></span><br></pre></td></tr></table></figure>
<p>在调用函数的时候，若形参个数和实参个数不相同时，Lua会自动调整实参个数。调整规则为：</p>
<p>若实参个数大于形参个数，从左到右，多余的实参被忽略；</p>
<p>若实参个数小于形参个数，从左到右，没有被实参初始化的形参会被初始化为nil</p>
</li>
<li><p>变长参数</p>
<p>若形参为…，表示该函数可以接收不同长度的参数，访问参数的时候也要使用…。</p>
<p>LuaJIT2尚不能实时编译这种变长参数的用法，只能解释执行，所以对性能敏感的代码，应当避免使用这种形式。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">func</span><span class="params">( ... )</span></span>                <span class="comment">-- 形参为 ... ,表示函数采用变长参数</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">local</span> temp = &#123;...&#125;                     <span class="comment">-- 访问的时候也要使用 ...</span></span><br><span class="line">   <span class="keyword">local</span> ans = <span class="built_in">table</span>.<span class="built_in">concat</span>(temp, <span class="string">" "</span>)    <span class="comment">-- 使用 table.concat 库函数对数</span></span><br><span class="line">                                          <span class="comment">-- 组内容使用 " " 拼接成字符串。</span></span><br><span class="line">   <span class="built_in">print</span>(ans)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">func(<span class="number">1</span>, <span class="number">2</span>)        <span class="comment">-- 传递了两个参数</span></span><br><span class="line">func(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)  <span class="comment">-- 传递了四个参数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--&gt;output</span></span><br><span class="line"><span class="number">1</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>具名参数</p>
<p>Lua支持通过名称来指定实参，这时候要把所有的实参组织到一个table中，并将这个table作为唯一的实参传给函数。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">change</span><span class="params">(arg)</span></span> <span class="comment">-- change 函数，改变长方形的长和宽，使其各增长一倍</span></span><br><span class="line">  <span class="built_in">arg</span>.width = <span class="built_in">arg</span>.width * <span class="number">2</span></span><br><span class="line">  <span class="built_in">arg</span>.height = <span class="built_in">arg</span>.height * <span class="number">2</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">arg</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> rectangle = &#123; width = <span class="number">20</span>, height = <span class="number">15</span> &#125;</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"before change:"</span>, <span class="string">"width  ="</span>, rectangle.width,</span><br><span class="line">                        <span class="string">"height ="</span>, rectangle.height)</span><br><span class="line">rectangle = change(rectangle)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"after  change:"</span>, <span class="string">"width  ="</span>, rectangle.width,</span><br><span class="line">                        <span class="string">"height ="</span>, rectangle.height)</span><br><span class="line"></span><br><span class="line"><span class="comment">--&gt;output</span></span><br><span class="line">before change: width = <span class="number">20</span>  height =  <span class="number">15</span></span><br><span class="line">after  change: width = <span class="number">40</span>  height =  <span class="number">30</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>按引用传递</p>
<p>当函数参数是table类型时，传递进来的是实际参数的引用，此时在函数内部对该table所做的修改，会直接对所传递的实际参数生效，而无需自己返回结果。</p>
</li>
</ul>
<h3><span id="返回值">返回值</span></h3><p>Lua允许函数返回多个值。</p>
<h2><span id="模块">模块</span></h2><h2><span id="string库">String库</span></h2><h2><span id="table库">Table库</span></h2><h2><span id="日期时间函数">日期时间函数</span></h2><h2><span id="数学库函数">数学库函数</span></h2><h2><span id="文件操作">文件操作</span></h2><h1><span id="高阶">高阶</span></h1><h2><span id="元表">元表</span></h2><h2><span id="面向对象编程">面向对象编程</span></h2><h2><span id="局部变量">局部变量</span></h2><h2><span id="判断数组大小">判断数组大小</span></h2><h2><span id="非空判断">非空判断</span></h2><h2><span id="正则表达式">正则表达式</span></h2><h2><span id="虚变量">虚变量</span></h2><h2><span id="ffi">FFI</span></h2>
                </div>
            </div>
    
            <nav class="post-pagination">
    
    <a class="newer-posts" href="/2017/02/26/Nginx源码分析之内存池管理/">
        前の記事<br>Nginx源码分析之内存池管理
    </a>
    
    <span class="page-number"></span>
    
    <a class="older-posts" href="/2017/02/23/持续交付/">
        次の記事<br>持续交付
    </a>
    
</nav>

    
            


        </div>
    </div>
    <div class="single-column-footer">
    Proudly published with Hexo<br>
    
    Theme <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> by <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a><br>
    
    &copy; 2018 <a href="http://yoursite.com">javfa&#39;s blog</a>
</div>
</div>

</div>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.4/dist/umd/popper.min.js" integrity="sha256-EGs9T1xMHdvM1geM8jPpoo8EZ1V1VRsmcJz8OByENLA=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js" integrity="sha256-VsEqElsCHSGmnmHXGQzvoWjWwoznFSZc6hs7ARLRacQ=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.min.js" integrity="sha256-FtWfRI+thWlNz2sB3SJbwKx5PgMyKIVgwHCTwa3biXc=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/smooth-scroll@14.2.1/dist/smooth-scroll.polyfills.min.js" integrity="sha256-CI4Gq5E0io1Pv0xM3qPM+NUIOhbIBvC3GiN1Y4KhXpw=" crossorigin="anonymous"></script>
<script src="/js/journal.js?85114568"></script>



</body>
</html>
